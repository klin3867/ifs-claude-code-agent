# IFS Cloud Knowledge Base for DeepAgent
# Combined procedural rules + semantic domain facts
# Retrieved using keyword matching (same as episodic memory)

# =============================================================================
# PROCEDURAL RULES - Tool-specific instructions (migrated from seed_memories.json)
# =============================================================================

procedural:
  create_shipment_order:
    keywords: [shipment, create, ship, move, transfer, transport]
    rules:
      # Parameters are auto-extracted from MCP schema at runtime (Part 7)
      - "Always determine the part_no before creating a shipment order - the order is useless without lines"
      - "The shipment_order_id returned is a NUMBER (e.g., 34), not a string like 'SO-123'"
      - "The MCP server normalizes shorthand warehouse IDs: '205' → 'AC-A205', '110' → 'AC-A110'"
      - "IMPORTANT: '105' or 'Warehouse 105' means the site 'AC' itself - use 'AC' as the warehouse value, NOT 'AC-A105'"
      - "For site AC: use 'AC' for the main site (105), '205' or 'AC-A205' for remote warehouse"

  add_shipment_order_line:
    keywords: [shipment, line, add, part, item, qty]
    rules:
      # Parameters are auto-extracted from MCP schema at runtime (Part 7)
      - "Use the EXACT shipment_order_id number from create_shipment_order response"
      - "Pass shipment_order_id as an INTEGER, not a string"
      - "Quantity parameter is 'qty_to_ship' (not 'quantity' or 'qty')"
      - "Required params: shipment_order_id, part_no, qty_to_ship"

  release_shipment_order:
    keywords: [shipment, release, approve, finalize]
    rules:
      - "Only release after successfully adding at least one line"
      - "Use the same integer shipment_order_id from the create response"

  get_inventory_stock:
    keywords: [inventory, stock, onhand, available, qty, quantity, level]
    rules:
      - "Use part_no (not part or part_number)"
      - "Site parameter is 'site' (e.g., 'AC')"
      - "Returns all warehouses at the site - don't specify warehouse here"

  analyze_unreserved_demand_by_warehouse:
    keywords: [order, orders, demand, fulfillment, shortage, unreserved, warehouse, cascade, review, shipping, ship, inventory, enough, sufficient, week, supply, transfer, move, create, refill, replenish]
    rules:
      - "Primary tool for 'review orders and check inventory' queries"
      - "compact_response=true (default) returns ~200 tokens; false returns full ~2000+ token details"
      - "⚠️ CRITICAL: When user says 'create shipment orders', 'refill', 'replenish', or 'supply warehouse' → USE auto_create_shipments=true"
      - "DO NOT manually call create_shipment_order + add_shipment_order_line - the tool does it automatically!"
      - "target_warehouse is the DESTINATION - where inventory should END UP (e.g., '205' for A205)"
      - "warehouse_priority determines search order for SOURCE warehouses (e.g., ['110','105'] to pull from those)"
      - "FULL EXAMPLE: analyze_unreserved_demand_by_warehouse(target_warehouse='205', warehouse_priority=['110','105'], auto_create_shipments=true, days_ahead=7)"
      - "This ONE call analyzes demand, checks inventory, finds shortfalls, AND creates all shipment orders automatically"

  # ⭐ COMPOSITE TOOLS - Use these for efficiency (fewer API calls)

  create_order_with_lines:
    keywords: [create, order, lines, multi, batch, new order, customer order, place order, multiple lines]
    rules:
      - "⭐ COMPOSITE: Use instead of create_order + add_order_line (xN) = saves N calls"
      - "Pass lines as array: [{catalog_no, buy_qty_due, sale_unit_price?, discount?}]"
      - "Creates order header + all lines atomically"
      - "Example: create_order_with_lines(customer_no='1023', lines=[{catalog_no:'20102', buy_qty_due:100}])"

  bulk_update_order_lines:
    keywords: [update, order, lines, bulk, batch, modify, change, multiple]
    rules:
      - "⭐ COMPOSITE: Use instead of update_order_line (xN) = saves N-1 calls"
      - "Pass updates as array: [{line_no, buy_qty_due?, sale_unit_price?, discount?}]"
      - "Example: bulk_update_order_lines(order_no='*1234', updates=[{line_no:'1', buy_qty_due:200}])"

  plan_and_execute_reservation:
    keywords: [reserve, reservation, plan, execute, FEFO, shipment, allocate]
    rules:
      - "⭐ COMPOSITE: Use instead of plan_shipment_reservation_fefo + execute_shipment_reservation_plan = saves 1 call"
      - "Combines FEFO planning and execution in one call"
      - "Set auto_execute=false to get plan only"
      - "Example: plan_and_execute_reservation(shipment_order_id='25', line_no='1', qty_needed=100)"

  create_and_allocate_shipment:
    keywords: [create, shipment, lines, transfer, move, allocate, release, multi]
    rules:
      - "⭐ COMPOSITE: Use instead of create_shipment + add_line (xN) + release = saves N+1 calls"
      - "Creates shipment, adds all lines, and releases automatically"
      - "Pass lines as array: [{part_no, qty_to_ship}]"
      - "Example: create_and_allocate_shipment(from_warehouse='110', to_warehouse='205', lines=[{part_no:'20102', qty_to_ship:100}])"

  get_part_with_availability:
    keywords: [part, availability, stock, inventory, warehouse, check, info, level]
    rules:
      - "⭐ COMPOSITE: Use instead of get_part + get_inventory_stock = saves 2 calls"
      - "Returns part info + stock by warehouse + totals in one call"
      - "Example: get_part_with_availability(part_no='20102')"

  get_demand_exceptions_summary:
    keywords: [exception, past due, shortage, negative, demand, issues, problems, alerts]
    rules:
      - "⭐ COMPOSITE: Use instead of get_past_due + get_shortages + get_negative_stock = saves 2 calls"
      - "Combines all demand exceptions in one view"
      - "Example: get_demand_exceptions_summary(site='AC', days_ahead=7)"

  check_inventory_by_warehouse:
    keywords: [inventory, warehouse, stock, check, specific, location, level]
    rules:
      - "Check inventory for a specific warehouse"
      - "Can filter by part_no and min_available"
      - "Example: check_inventory_by_warehouse(warehouse='205', min_available=10)"

  get_past_due_orders:
    keywords: [past due, overdue, late, orders, delay, behind, backlog]
    rules:
      - "Get all past due order lines"
      - "Can filter by customer_no and days_overdue"
      - "Example: get_past_due_orders(days_overdue=7)"

# =============================================================================
# SEMANTIC FACTS - Domain knowledge about IFS Cloud
# =============================================================================

semantic:
  intent_mapping:
    keywords: [move, transfer, ship, reserve, allocate, hold, stock, onhand]
    facts:
      - "When user says 'move', 'transfer', or 'ship' → use Shipment Workflow (create_shipment_order + add_shipment_order_line + release_shipment_order)"
      - "When user says 'reserve', 'allocate', or 'hold' → use Reservation Workflow (plan_reservation + execute_reservation)"
      - "When user says 'check stock', 'inventory', or 'onhand' → use get_inventory_stock"
      - "When user says 'place order' or 'new order' → use Order Workflow (create_order + add_order_line)"

  sites:
    keywords: [site, sites, contract, location, warehouse, warehouses, "105", "110", "205"]
    facts:
      - "Site AC has remote warehouses: AC-A110, AC-A205"
      - "'105' or 'Warehouse 105' means site AC itself - use 'AC' as the warehouse value, NOT 'AC-A105'"
      - "Default site is 'AC' unless user specifies otherwise"
      - "Shorthand: '205' → 'AC-A205', '110' → 'AC-A110', '105' → 'AC' (site itself)"

  shipments:
    keywords: [shipment, ship, move, transfer, transport]
    facts:
      - "Shipment orders require 3 steps: create_shipment_order -> add_shipment_order_line -> release_shipment_order"
      - "create_shipment_order uses from_warehouse and to_warehouse parameters"
      - "shipment_order_id is always an INTEGER (e.g., 34), never a string like 'SO-34'"
      - "MCP server normalizes: '205' → 'AC-A205', '110' → 'AC-A110', but '105' → use 'AC' directly"

  inventory:
    keywords: [inventory, stock, qty, quantity, onhand, available, reserve]
    facts:
      - "Use get_inventory_stock to check ALL warehouses at a site"
      - "Use search_inventory_by_warehouse for ONE specific warehouse only"
      - "Parameter is 'part_no' (not 'part' or 'part_number')"

  orders:
    keywords: [order, customer, sales, line]
    facts:
      - "Order numbers with asterisks like '*1063' should include the asterisk"
      - "Parameter is 'order_no' (not 'order_number' or 'orderNo')"

# =============================================================================
# COMMON ERRORS - Error patterns to avoid (migrated from seed_memories.json)
# =============================================================================

common_errors:
  - pattern: "shipment_order_id as string"
    keywords: [shipment, order, id, string]
    correction: "Use integer from create_shipment_order response (e.g., 34 not '34' or 'SO-34')"

  - pattern: "missing part_no for shipment"
    keywords: [shipment, part, missing]
    correction: "Ask user which part to move before creating shipment order"
